<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Kai Ika – Weekly Can Pickup</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0" />

<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

<style>
  :root {
    --kai-green: #1f7a63;
    --kai-green-dark: #155e4b;
    --kai-sand: #f4f7f6;
    --kai-grey: #e3e8e6;
    --kai-text: #1e2d2a;
  }
  * { box-sizing: border-box; }
  body { margin:0; font-family:"Inter", system-ui, sans-serif; background: var(--kai-sand); color: var(--kai-text); }
  header { background:white; border-bottom:1px solid var(--kai-grey); padding:1.25rem 1.5rem; }
  header h1 { margin:0; font-size:1.4rem; font-weight:700; color: var(--kai-green); }
  main { max-width:1100px; margin:0 auto; padding:1.5rem; }
  .card { background:white; border-radius:12px; padding:1.5rem; box-shadow:0 8px 20px rgba(0,0,0,0.04); }
  .card-header { display:flex; justify-content:space-between; align-items:center; margin-bottom:1rem; }
  button { background: var(--kai-green); color:white; border:none; border-radius:8px; padding:0.6rem 1rem; font-size:0.9rem; font-weight:600; cursor:pointer; }
  button:disabled { background:#9bbfb6; cursor:not-allowed; }
  table { width:100%; border-collapse:collapse; margin-top:1rem; }
  thead { background: var(--kai-grey); }
  th, td { padding:0.65rem; font-size:0.85rem; text-align:left; }
  th { text-transform:uppercase; font-size:0.75rem; letter-spacing:0.05em; }
  tbody tr { border-bottom:1px solid var(--kai-grey); }
  select, input[type="number"], input[type="text"] { width:100%; padding:0.4rem; border-radius:6px; border:1px solid var(--kai-grey); }
  .muted { color:#6b7a77; font-size:0.85rem; }
  .actions { margin-top:1.25rem; display:flex; justify-content:flex-end; gap:0.5rem; }
  /* Modal styles */
  .modal { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.4); justify-content:center; align-items:center; }
  .modal-content { background:white; padding:1.5rem; border-radius:12px; max-width:400px; width:90%; }
  .modal-content h3 { margin-top:0; }
  .modal-content label { display:block; margin-top:0.75rem; font-weight:500; }
</style>
</head>

<body>

<header>
  <h1>Kai Ika – Weekly Can Pickup</h1>
</header>

<main>

<div class="card">
  <div class="card-header">
    <h2>This Week’s Pickup Schedule</h2>
    <div>
      <button id="loadBtn">Load This Week</button>
      <button id="addSiteBtn">Add a Site</button>
    </div>
  </div>

  <p class="muted">Automatically calculated based on pickup frequency and last collection.</p>

  <div style="overflow-x:auto;">
    <table>
      <thead>
        <tr>
          <th>Site</th>
          <th>Address</th>
          <th>Frequency</th>
          <th>Receptacle</th>
          <th>Bins</th>
          <th>Fill Qty</th>
        </tr>
      </thead>
      <tbody id="tableBody">
        <tr>
          <td colspan="6" class="muted">No data loaded.</td>
        </tr>
      </tbody>
    </table>
  </div>

  <div class="actions">
    <button id="submitBtn" disabled>Submit Pickup Data</button>
  </div>
</div>

<!-- Modal for adding a site -->
<div id="addSitePopup" style="display:none; position:fixed; top:50%; left:50%; transform:translate(-50%,-50%); background:white; padding:1.5rem; border-radius:12px; box-shadow:0 8px 20px rgba(0,0,0,0.1); z-index:100;">
  <h3>Add a Site</h3>
  <label>
    Name
    <input type="text" id="newSiteName">
  </label>
  <label>
    Address
    <input type="text" id="newSiteAddress">
  </label>
  <label>
    Pickup Type
    <select id="newSiteType">
      <option value="Scheduled">Scheduled</option>
      <option value="On-Call">On-Call</option>
    </select>
  </label>
  <div style="margin-top:1rem; display:flex; justify-content:flex-end; gap:0.5rem;">
    <button id="addSiteCancel">Cancel</button>
    <button id="addSiteSubmit">Add Site</button>
  </div>
</div>

<!-- Initialization overlay -->
<div id="initOverlay" class="modal" style="display:flex; background:#fff;">
  <div class="modal-content">
    <h3>Paste your Script URL</h3>
    <input type="text" id="scriptUrl" placeholder="https://script.google.com/macros/.../exec" style="width:100%;">
    <div style="margin-top:1rem; text-align:right;">
      <button id="initBtn">Initialize</button>
    </div>
  </div>
</div>

<script>
let API_URL = "";

const loadBtn = document.getElementById("loadBtn");
const submitBtn = document.getElementById("submitBtn");
const addSiteBtn = document.getElementById("addSiteBtn");
const tableBody = document.getElementById("tableBody");

const modal = document.getElementById("modal");
const manualName = document.getElementById("manualName");
const manualAddress = document.getElementById("manualAddress");
const manualFrequency = document.getElementById("manualFrequency");
const manualType = document.getElementById("manualType");
const saveManual = document.getElementById("saveManual");
const cancelManual = document.getElementById("cancelManual");

const initOverlay = document.getElementById("initOverlay");
const scriptUrlInput = document.getElementById("scriptUrl");
const initBtn = document.getElementById("initBtn");

// ============================
// Initialization
// ============================
initBtn.addEventListener("click", () => {
  const url = scriptUrlInput.value.trim();
  if(!url) return alert("Please paste the script URL.");
  API_URL = url;
  initOverlay.style.display = "none";
});

// ============================
// Load Schedule
// ============================
loadBtn.addEventListener("click", async () => {
  if(!API_URL) return alert("Please initialize first.");
  loadBtn.disabled = true;
  tableBody.innerHTML = `<tr><td colspan="6">Loading…</td></tr>`;

  try {
    const res = await fetch(`${API_URL}?action=getWeeklySchedule`);
    const data = await res.json();

    if (!Array.isArray(data) || data.length === 0) {
      tableBody.innerHTML = `<tr><td colspan="6" class="muted">No pickups due this week.</td></tr>`;
      submitBtn.disabled = true;
      return;
    }

    renderRows(data);
    submitBtn.disabled = false;

  } catch (err) {
    tableBody.innerHTML = `<tr><td colspan="6">Error loading data</td></tr>`;
    console.error(err);
  } finally {
    loadBtn.disabled = false;
  }
});

// ============================
// Render Rows
// ============================
function renderRows(sites) {
  tableBody.innerHTML = "";

  sites.forEach(site => {
    const tr = document.createElement("tr");
    tr.dataset.siteId = site.siteId || site.siteName;

    tr.innerHTML = `
      <td>${site.siteName}</td>
      <td>${site.address}</td>
      <td>${site.frequency}</td>
      <td>
        <select>
          <option value="">Select</option>
          <option value="Farro cage">Farro cage</option>
          <option value="Wheelie bin">Wheelie bin</option>
        </select>
      </td>
      <td><input type="number" min="0" step="1"></td>
      <td><input type="number" min="0" step="0.1"></td>
    `;

    tableBody.appendChild(tr);
  });
}

// ============================
// Submit Pickup Data
// ============================
submitBtn.addEventListener("click", async () => {
  const rows = [...tableBody.querySelectorAll("tr")];
  const payload = rows.map(row => {
    const cells = row.children;
    return {
      siteId: row.dataset.siteId,
      siteName: cells[0].textContent,
      address: cells[1].textContent,
      frequency: cells[2].textContent,
      receptacle: cells[3].querySelector("select").value,
      numberOfBins: cells[4].querySelector("input").value,
      fillQuantity: cells[5].querySelector("input").value
    };
  }).filter(r => r.receptacle);

  if(payload.length === 0) return alert("Nothing to submit.");

  submitBtn.disabled = true;
  try {
    await fetch(`${API_URL}?action=submitPickupData`, {
      method:"POST",
      body: JSON.stringify(payload)
    });
    alert("Pickup data submitted successfully.");
  } catch(err) {
    alert("Submission failed.");
    console.error(err);
  } finally { submitBtn.disabled = false; }
});

// ============================
// Add Manual Site
// ============================
addSiteBtn.addEventListener("click", () => {
  manualName.value = "";
  manualAddress.value = "";
  manualFrequency.value = "Weekly";
  manualType.value = "Scheduled";
  modal.style.display = "flex";
});

cancelManual.addEventListener("click", () => modal.style.display = "none");

saveManual.addEventListener("click", async () => {
  const site = {
    siteName: document.getElementById("newSiteName").value,
    address: document.getElementById("newSiteAddress").value,
    pickupType: document.getElementById("newSiteType").value,
    date: new Date() // optional, can default to today
  };

  if(!site.siteName) return alert("Site name is required.");
  if(!API_URL) return alert("Please initialize first.");

  try {
    const res = await fetch(`${API_URL}?action=addManualSite`, {
      method:"POST",
      body: JSON.stringify(site)
    });
    const data = await res.json();
    if(data.success){
      modal.style.display = "none";
      renderRows([...document.querySelectorAll("tr")].map(tr => ({
        siteId: tr.dataset.siteId,
        siteName: tr.children[0].textContent,
        address: tr.children[1].textContent,
        frequency: tr.children[2].textContent
      })), site); // add new site
      alert("Site added to this week's schedule.");
    }
  } catch(err){
    console.error(err);
    alert("Failed to add site.");
  }
});

// Helper: append new manual site row after render
function renderRows(existingSites, newSite){
  const sites = [...existingSites];
  if(newSite) sites.push({...newSite, siteId:newSite.siteName});
  tableBody.innerHTML = "";
  sites.forEach(site => {
    const tr = document.createElement("tr");
    tr.dataset.siteId = site.siteId;
    tr.innerHTML = `
      <td>${site.siteName}</td>
      <td>${site.address || ""}</td>
      <td>${site.frequency || ""}</td>
      <td>
        <select>
          <option value="">Select</option>
          <option value="Farro cage">Farro cage</option>
          <option value="Wheelie bin">Wheelie bin</option>
        </select>
      </td>
      <td><input type="number" min="0" step="1"></td>
      <td><input type="number" min="0" step="0.1"></td>
    `;
    tableBody.appendChild(tr);
  });
}
</script>

</body>
</html>
